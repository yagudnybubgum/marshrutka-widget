# Кейс стади: Виджет расписания маршруток

## Обзор проекта

**Marshrutka Widget** — веб-приложение для отображения расписания маршрутных такси в реальном времени. Приложение позволяет пользователям видеть ближайшие рейсы по двум маршрутам (533 и 429) в поселке Янино-1, Ленинградская область.

### Основная проблема
Жителям поселка нужно быстро узнавать, когда прибудет следующая маршрутка, чтобы планировать свое время. Традиционные способы (таблицы на остановках, бумажные расписания) неудобны и не всегда актуальны.

### Решение
Интерактивный веб-виджет, который:
- Автоматически загружает расписание из Excel-файлов
- Определяет ближайшие рейсы в реальном времени
- Адаптируется к будним/выходным дням и праздникам
- Работает на всех устройствах (responsive design)
- Может быть добавлен на главный экран смартфона (PWA-ready)

---

## Технологический стек

### Frontend
- **React 18.2.0** — UI библиотека
- **React Router DOM 7.11.0** — клиентская маршрутизация
- **Vite 5.0.8** — сборщик и dev-сервер (быстрая разработка, HMR)
- **Tailwind CSS 3.4.0** — utility-first CSS фреймворк
- **DaisyUI 5.5.5** — компонентная библиотека на базе Tailwind

### Обработка данных
- **XLSX.js 0.18.5** — парсинг Excel-файлов (.xlsx) в браузере

### Инфраструктура
- **Docker** — контейнеризация приложения
- **Nginx** — веб-сервер для production (статическая раздача + SPA routing)
- **Node.js 20** — среда выполнения для сборки

### Деплой
- **GitHub Pages** — хостинг статики (через GitHub Actions)
- **Coolify** — альтернативный вариант деплоя (Docker-based)

### Аналитика
- **Yandex.Metrika** — отслеживание посещений и поведения пользователей

---

## Архитектура приложения

### Структура проекта

```
marshrutka-widget/
├── src/
│   ├── components/          # React компоненты
│   │   ├── MarshrutkaWidget.jsx    # Основной виджет расписания
│   │   ├── Home.jsx                # Главная страница
│   │   ├── FullSchedule*.jsx       # Полные расписания
│   │   ├── HomeScreen.jsx          # Инструкция по добавлению на главный экран
│   │   ├── About.jsx               # О проекте
│   │   └── PrivacyPolicy.jsx       # Политика конфиденциальности
│   ├── utils/
│   │   └── holidays.js              # Логика определения праздников
│   ├── App.jsx                     # Роутинг
│   ├── main.jsx                    # Точка входа
│   └── index.css                   # Глобальные стили
├── public/                  # Статические файлы
│   ├── schedule-533.xlsx    # Расписание маршрута 533
│   ├── schedule-429.xlsx    # Расписание маршрута 429
│   └── fonts/               # Кастомные шрифты (Google Sans)
├── dist/                    # Собранное приложение (для деплоя)
├── Dockerfile               # Мультистейдж сборка (Node → Nginx)
├── nginx.conf              # Конфигурация Nginx
└── vite.config.js          # Конфигурация Vite
```

### Ключевые компоненты

#### 1. MarshrutkaWidget.jsx
Центральный компонент приложения, отвечающий за:
- Загрузку Excel-файлов расписания
- Парсинг данных с учетом формата (будние/выходные дни)
- Определение ближайших рейсов в реальном времени
- Отображение расписания с таймерами

**Ключевые функции:**
- `loadScheduleFile()` — загрузка и парсинг Excel
- `processScheduleData()` — обработка данных с учетом дня недели
- `getScheduleWindow()` — вычисление ближайших рейсов
- `parseTime()` — парсинг времени из разных форматов (HH:MM, Excel time, минуты)

#### 2. holidays.js
Утилита для определения праздничных дней:
- Список праздников 2026 года
- Функция `isWeekendOrHoliday()` — проверка выходного дня
- Поддержка переносов выходных дней

#### 3. Роутинг
Приложение использует React Router для навигации:
- `/` — главная страница с виджетом
- `/full533`, `/full429` — полные расписания
- `/homescreen` — инструкция по добавлению на главный экран
- `/about` — информация о проекте
- `/privacy-policy` — политика конфиденциальности

---

## Ключевые особенности реализации

### 1. Автоматическая обработка расписаний

Приложение поддерживает два формата Excel-файлов:

**Формат с периодом** (маршрут 533):
- Строка 1: указание периода (будние/выходные)
- Строка 2: названия направлений
- Строка 3+: время отправления

**Формат без периода** (маршрут 429):
- Строка 1: названия направлений
- Строка 2+: время отправления

Система автоматически определяет формат и выбирает нужные колонки в зависимости от дня недели.

### 2. Умное определение времени

Парсер времени поддерживает множественные форматы:
- `HH:MM` (например, "14:30")
- `HH.MM` (например, "14.30")
- Excel time format (число от 0 до 1)
- Минуты от начала дня (0-1439)

### 3. Реальное время

- Обновление каждую секунду для точного отображения
- Автоматический переход на следующий день
- Подсчет времени до ближайшего рейса
- Отображение предыдущего и следующих рейсов

### 4. Адаптивность к дням недели

- Автоматическое определение будних/выходных дней
- Учет праздников (список для 2026 года)
- Переключение между расписаниями в зависимости от типа дня

### 5. Оптимизация производительности

- **Vite** — быстрая сборка и HMR в разработке
- **Code splitting** — автоматическое разделение кода
- **Gzip compression** — сжатие в Nginx
- **Кэширование статики** — долгосрочное кэширование ресурсов
- **Lazy loading** — загрузка компонентов по требованию

### 6. PWA-ready

- Адаптивный дизайн для мобильных устройств
- Инструкция по добавлению на главный экран
- Работа в офлайн-режиме (через кэш браузера)

---

## Процесс разработки

### Сборка проекта

```bash
# Разработка
npm run dev          # Запуск dev-сервера (Vite)

# Production
npm run build        # Сборка в папку dist/
npm run preview      # Предпросмотр production сборки
```

### Деплой

**GitHub Pages:**
```bash
npm run deploy       # Сборка + деплой через gh-pages
```

**Docker (Coolify):**
- Мультистейдж сборка: Node.js для сборки → Nginx для production
- Оптимизированный образ (только статика в финальном образе)
- Автоматический SSL через Let's Encrypt

---

## UX/UI особенности

### Дизайн
- Минималистичный интерфейс
- Кастомный шрифт Google Sans
- DaisyUI компоненты для консистентности
- Светлая тема (data-theme="light")

### Интерактивность
- Переключение между маршрутами (533/429)
- Подсветка ближайшего рейса
- Отображение времени до отправления
- Индикация "завтра" для рейсов следующего дня

### Адаптивность
- Mobile-first подход
- Responsive grid layout
- Оптимизация для touch-устройств

---

## Метрики и аналитика

- **Yandex.Metrika** интегрирована для отслеживания:
  - Количество посещений
  - Время на сайте
  - Популярность маршрутов (533 vs 429)
  - Устройства пользователей

---

## Технические решения

### 1. Обработка путей в production

Приложение корректно работает как на GitHub Pages (с base path), так и на собственном домене:

```javascript
const getBasePath = () => {
  const viteBase = import.meta.env.BASE_URL
  if (viteBase && viteBase !== '/') {
    return viteBase
  }
  // Fallback для определения из URL
  const path = window.location.pathname
  if (path.includes('/marshrutka-widget/')) {
    return '/marshrutka-widget/'
  }
  return '/'
}
```

### 2. SPA Routing в Nginx

```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

Все маршруты обрабатываются через `index.html`, что позволяет React Router работать корректно.

### 3. Безопасность

- Security headers в Nginx (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection)
- HTTPS через Let's Encrypt (при деплое через Coolify)

### 4. Оптимизация загрузки

- Кэширование статических ресурсов (1 год)
- Gzip compression для текстовых файлов
- Минификация и оптимизация через Vite

---

## Результаты

### Достижения
- ✅ Быстрый доступ к расписанию в реальном времени
- ✅ Адаптивность к будним/выходным дням
- ✅ Простое обновление расписания (замена Excel-файла)
- ✅ Работа на всех устройствах
- ✅ Низкая стоимость хостинга (GitHub Pages бесплатно)

### Технические метрики
- **Размер бандла**: оптимизирован через Vite
- **Время загрузки**: < 1 секунда на быстром соединении
- **Поддержка браузеров**: современные браузеры (ES6+)

---

## Будущие улучшения

Потенциальные направления развития:
- Push-уведомления о приближении маршрутки
- Интеграция с GPS для отслеживания транспорта в реальном времени
- История поездок пользователя
- Мультиязычность
- Темная тема
- Экспорт расписания в календарь

---

## Заключение

Проект демонстрирует эффективное использование современных веб-технологий для решения практической задачи. Применение React, Vite, Tailwind CSS и Docker позволяет создать быстрое, масштабируемое и легко поддерживаемое приложение. Простота обновления данных (замена Excel-файла) делает решение удобным для конечных пользователей и администраторов.



ё